#!/usr/bin/env zsh
echo "Rebuilding"
local nix() {
  command nix --extra-experimental-features 'nix-command flakes' $@
}
if [ -f /etc/os-release ]; then
  sudo nixos-rebuild \
    --flake '/etc/nixos#'"$(hostname)" \
    ${1+"$@"} switch
else
  cd $HOME/src/personal/nixos-configs >/dev/null || exit
  if command -v darwin-rebuild >/dev/null; then
    darwin-rebuild --flake $HOME/src/personal/nixos-configs ${1+"$@"} switch
  else
    hostname="$(hostname)"
    while [ ! -L ./result ]; do
      nix build .#darwinConfigurations."${hostname%\.local}".system --keep-going ${1+"$@"}
    done
    ./result/sw/bin/darwin-rebuild --flake $HOME/src/personal/nixos-configs ${1+"$@"} switch
  fi
  rm -f $HOME/src/personal/nixos-configs/result
fi
